name: Java Docker CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:  # permite ejecutar manualmente

jobs:
  build-and-deploy:
    runs-on: windows-latest

    env:
      IMAGE_NAME: hola-mundo
      CONTAINER_NAME: hola-mundo
      PORT: 8000

    steps:
      # 1Ô∏è‚É£ Limpiar workspace
      - name: Clean workspace
        run: |
          Write-Host "üßπ Limpiando workspace..."
          Remove-Item -Recurse -Force *
        shell: pwsh

      # 2Ô∏è‚É£ Checkout del repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 3Ô∏è‚É£ Setup Java
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      # 4Ô∏è‚É£ Build Maven project
      - name: Build Maven project
        run: |
          Write-Host "üì¶ Compilando proyecto Maven..."
          mvn clean package -DskipTests
        shell: pwsh

      # 5Ô∏è‚É£ Build Docker image
      - name: Build Docker image
        run: |
          Write-Host "üê≥ Construyendo imagen Docker..."
          docker build -t $env:IMAGE_NAME:latest .
        shell: pwsh

      # 6Ô∏è‚É£ Stop old container if exists
      - name: Stop old container
        run: |
          Write-Host "‚èπ Deteniendo contenedor antiguo si existe..."
          $container = docker ps -q -f "name=$env:CONTAINER_NAME"
          if ($container) {
              docker stop $container
              docker rm $container
          } else {
              Write-Host "No existe contenedor $env:CONTAINER_NAME"
          }
        shell: pwsh

      # 7Ô∏è‚É£ Run Docker container
      - name: Run Docker container
        run: |
          Write-Host "üèÉ‚Äç‚ôÇÔ∏è Ejecutando contenedor..."
          docker run -d --name $env:CONTAINER_NAME -p $env:PORT:8000 $env:IMAGE_NAME:latest
        shell: pwsh

      # 8Ô∏è‚É£ Post: success message
      - name: Success
        if: success()
        run: Write-Host "‚úÖ Despliegue completado. La app est√° corriendo en http://localhost:$env:PORT"
        shell: pwsh

      # 9Ô∏è‚É£ Post: failure message
      - name: Failure
        if: failure()
        run: Write-Host "‚ùå Error en el workflow"
        shell: pwsh
